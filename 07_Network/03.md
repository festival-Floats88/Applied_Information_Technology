# **3. ネットワーク層**

## **1. ネットワーク層のプロトコル**

TCP/IPのネットワーク層には, ICMP, IP, ARP/RARPなどのプロトコルが含まれ, その中心はIPである.

## **2. IP**(Internet Protocol)**の役割**

**IP**の役割は, パケットを中継してエンドノードに送り届けることにある. これを行うため, IPパケットのヘッダには, 送信元と宛先のIPアドレスが指定される.

IPアドレスは, 各ノードとネットワークとの接点(接続ポート)毎に付与される. ルータなどの複数のネットワークを接続する機器には, 接続ポート毎に異なるIPアドレスが付与されることになる.

> IPアドレスはLANへの接続ポート毎に付与する

## **3. IPアドレス**

**IPアドレス**は32bitのアドレスであり, 8bit毎にピリオドで区切り, 10進数で表記される.

IPアドレスは, 大きく**ネットワーク部**と**ホスト部**に分けられる. ネットワーク部は組織の識別に用いられ, ホスト部は同一組織に接続するホストの識別に用いられる. 同じ組織に属するホストには, ネットワーク部が等しく, ホスト部が異なるアドレスが割り当てられる.

> **ネットワーク部**: IPアドレスのうちネットワークを識別する部分
>
> **ホスト部**: IPアドレスのうちホストを識別する部分

### **特殊なIPアドレス**

IPアドレスのうち, ホスト部の値が「全て0(10進数で表すと0)」または「全て1(10進数で表すと255)」のアドレスは, 特別な用途に用いるため, ホスト部に割り当てることはできない.

ホスト部の値が全て0のアドレスは, **ネットワークアドレス**と呼ばれ, 特定のホストではなく「ネットワークそのもの」に付与される. ホスト部が全て1のアドレスは, ネットワークに属する「全てのホスト」を表すアドレスで, 全ホストを対象とする通信(**ブロードキャスト**)の宛先として用いられる.

> **ブロードキャスト**: ネットワーク上の全ホストに対する同報通信
>> **ユニキャスト**: 指定したアドレスにのみ送信する

以上から, ホスト部に割り当てられることができるIPアドレスの数は, ホスト部が *n* bitであるとき, 2^nから「全て0」と「全て1」を除いた, 2^n-2で求まられる.

### **プライベートアドレス**

IPアドレスのうち, 特に次の範囲に含まれるアドレスを**プライベートアドレス**と呼ぶ.

| クラス | プライベートアドレス |
| --: | :-- |
| A | 10.0.0.0 ~ 10.255.255.255 |
| B | 172.16.0.0 ~ 172.16.255.255 |
| C | 192.168.0.0 ~ 192.168.255.255 |

> クラスは, ネットワークの規模による分類だったが, 現在ではクラスそのものに意味はない

プライベートアドレスは, 会社などの組織内で自由に使えるアドレスである. 社内で一意であれば, 他社との重複は気にせずに利用できる. ただし, プライベートアドレスのままインターネットに接続することはできない.

プライベートアドレス以外のアドレスを**グローバルアドレス**と呼ぶ. グローバルアドレスは, インターネット上で一意であることが保証されたアドレスである. グローバルアドレスは, プロバイダから割り当てを受ける.

### **CIDR**(Classless Inter Domain Routing)

**CIDR**は, IPアドレスからクラスの枠組みを取り払い, 最適な規模のIPアドレスを割り当てる仕組み.

CIDRでは, ネットワーク部(及びサブネット識別子)の長さを自由に設定できる. これらの長さを**プレフィックス値**と呼び, IPアドレスの後にスラッシュとプレフィックス値を用いて表記する.

> **プレフィックス**: IPアドレスのうちサブネットを識別する部分(ネットワーク部 + サブネット識別子)
>> **プレフィックス値**: プレフィックスのbit数

プレフィックス値が大きければ, 相対的にホスト部のbit数は少なくなり, 利用できるIPアドレスも少なくなる. ネットワークの規模に見合ったプレフィックス値を用いることで, 限られた資源であるIPアドレスを, 有効に利用することができる.

### **データ伝送とサブネットマスク**

ホストはデータの送信に際して「宛先が自身と同じネットワークに存在するかどうか」を確かめる. もし同じネットワーク上にあれば宛先に直接フレームを送信し, そうでなければルータなどの中継機器にフレームを送出する.

「送信元と宛先が同じネットワークにある」ことは, 両社に付けられたIPアドレスのネットワーク部及びサブネット識別子の値が等しいかどうかで確かめることができる.

ネットワーク部及びサブネット識別子の比較は, 実際にはIPアドレスから「ホスト部のbitを0にしたアドレス」を生成して行う. ホスト部のbitのみを0にするためには, 以下のマスクパターンを用意して, これとIPアドレスとの論理積をとる.

- ネットワーク部及びサブネット識別子のbitが全て1
- ホスト部のbitが全て0

このとき用いるマスクパターンを**サブネットマスク**と呼ぶ.

> サブネットマスクであるかどうかは, 1の連続の後に0が連続するかどうかで見分ければよい

サブネットマスクのbit1の部分は, IPアドレスのネットワーク部及びサブネット識別子部分に対応する. この部分が大きくなればなるほど, 分割の進んだ小さなネットワークを表す.

### **IPv6**

現在, 主流の**IPv4**で用いられるIPアドレスは32bitであり, 世界的なインターネットの普及に伴ってIPアドレスの数が枯渇している. そこで**IPv6**と呼ばれる後継規格が策定された. IPv6は, 以下のようなIPv4の弱点を補う特徴を持っている.

- IPアドレスの128bit化
- ルータから通知される情報と自身が生成する情報からアドレスを自動生成する, プラグアンドプレイの実現
- IPsecを標準機能とすることによる暗号化機能の充実

## **4. ルーティング**

**ルーティング**は, パケットを送る最適な経路を選択することである.

ルーティングは, **ルーティングテーブル**に記録された**経路情報**に従って行われる. 経路情報の設定・維持に用いるプロトコルを特に**ルーティングプロトコル**といい, 次のものが代表的である.

| 名称 | 説明 |
| --: | :-- |
| RIP | ホップ数が最小となる経路を閃絡する距離ベクタ型のプロトコル |
| OSPF | 中継するリンクの状態を加味して経路を選択するリンクステート型のプロトコル |

> RIPは単純だが中継するリンクの状態を経路に反映できない
>> **ホップ数**: 経由するルータ数
>
> **距離ベクタ型ルーティングプロトコル**: 距離(ホップ数)と方向(ネクストホップ)に基づいてルートを計算する方式
>
> **リンクステート型ルーティングプロトコル**: 接続情報を交換し合い, 情報の集合に基づいて経路を選択する方式

### **1. ルーティングの仕組み**

ルーティングテーブルに記載される内容はベンダによって異なるが, 宛先ネットワークアドレス, データを伝送するインターフェース, 中継先となるルータ(ゲートウェイともいう)などから構成され, 「目的のネットワークを届けるためには, どのインターフェースから, どのルータに対して中継を依頼すればよいのか」を判断できるようになっている.

なお, 外部ネットワークへの出口が1つしかないネットワークや, 中継を依頼すべきルータが1つしかない場合には, **デフォルトゲートウェイ**を設定する. ルーティングテーブルに合致するエントリがない場合はデフォルトゲートウェイに中継を依頼することになる. この経路を**デフォルトルート**といい, 多くの場合, 宛先ネットワークのアドレスを0.0.0.0で表す.

> **デフォルトゲートウェイ**: 既定の中継先(ルータ)

### **2. 経路情報の集約**

複数のネットワークに到達するための中継先のルータが同一であり, ネットワークアドレスが集約可能であれば, CIDRの経路情報を集約することができる. 例えば, 宛先ネットワークアドレスが, 192.168.0.0/24, 192.168.1.0/24, 192.168.2..0/24で, どれも中継先ルータが全て同じの場合, 宛先ネットワークアドレスの上位22bitが共通しているので192.168.0.0/22に集約できる.

なお, このような経路情報の集約を行うと, 宛先ネットワークアドレスが複数のネットワークアドレスに該当することもある. この場合, 最もプレフィックスが長い経路を選択されることになる. これを**論ゲストマッチ**という.

## **5. ICMP**(Internet Control Message Protocol)

**ICMP**は, IPを利用した通信においてエラーメッセージや制御メッセージなどを転送するプロトコルである.

| TYPE | 内容 | 意味 |
|:-: | :-: | :-- |
| 0 | エコー応答 | エコー要求に対する応答 |
| 3 | 宛先到達不能 | 送信元ホストにパケットが到達しない原因を通知する |
| 5 | リダイレクト | 最適ルートが使用されていない場合に最適なルータを通知する |
| 8 | エコー要求 | 宛先ホストまでの到達確認 |
| 11 | 時間経過 | TTL(Time To Live)値が0になったことを通知する |

ICMPを利用したプログラムに**ping**がある. pingは, ICMPの**エコー要求**と**エコー応答**を利用してネットワークの到達確認を行う.

## **6. ARP/RARP**(Address Resolution Protocol/Reverse ARP)

ホストがフレームを中継先に送出するためには, 中継先のMACアドレスが必要だが, TCP/IPにはMACアドレスを一元管理する仕組みがないため, 「中継先のIPアドレスは判明しているがMACアドレスがわからない」という状況が起こる. このような場合に, IPアドレスからMACアドレスを問い合わせる**ARP**が用いられる.

ARPは, MACアドレスを問い合わせる**ARP要求**と, それに応える**ARP応答**からなっている. ARP要求はネットワーク中の全ノードに対するブロードキャストで, ARP応答は要求したノードへのユニキャストである.

ARpとは逆に, MACアドレスを基にIPアドレスを問い合わせるプロトコルが**RARP**である. RARPはディスクレスマシンなど, IPアドレスを記録できない機器が, 自身のIPアドレスを問い合わせる場合に利用される.
